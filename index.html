<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>BoardConsole Lite - Complete</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0f1115; --primary: #4aa3ff; --success: #2ecc71; --danger: #ff5c5c; }
        body { font-family: sans-serif; background: var(--bg); color: #e5e7eb; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: #161a22; padding: 25px; border-radius: 12px; border: 1px solid #2a2f3a; width: 100%; max-width: 500px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        h2 { color: var(--primary); margin-top: 0; }
        input { width: 90%; padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 2px solid #333; background: #000; color: #fff; margin-bottom: 15px; box-sizing: border-box; }
        button { width: 90%; padding: 15px; font-size: 1.1rem; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; margin-bottom: 10px; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        #status-msg { margin-top: 15px; font-weight: bold; color: #aaa; }
    </style>
</head>
<body>

<div id="setup-ui" class="container">
    <h2>BoardConsole Lite</h2>
    <p>å½¹å‰²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <button class="btn-primary" onclick="initRole('admin')">ğŸ’» ç®¡ç†è€…ç”»é¢ã‚’é–‹ã</button>
    <button class="btn-success" onclick="initRole('player')">ğŸ“± å›ç­”è€…ç”»é¢ã‚’é–‹ã</button>
</div>

<div id="admin-ui" class="container" style="display:none;">
    <h2>ç®¡ç†è€…ãƒ‘ãƒãƒ«</h2>
    <button class="btn-primary" onclick="openDisplay()">ğŸ“º è¦–è´è€…ç”¨ã‚µãƒ–ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã</button>
    <hr style="border:1px solid #333; margin:20px 0;">
    <button class="btn-success" style="font-size:1.5rem; height:80px;" onclick="db.ref('reveal').set(true)">ğŸ“¢ å›ç­”ã‚’ä¸€æ–‰å…¬é–‹</button>
    <button class="btn-danger" onclick="resetBoard()">ğŸš® å…¨å“¡ã®ãƒœãƒ¼ãƒ‰ã‚’æ¶ˆå»</button>
    <div id="status-msg">å›ç­”å¾…ã¡...</div>
</div>

<div id="player-ui" class="container" style="display:none;">
    <h2>å›ç­”è€…ãƒœãƒ¼ãƒ‰</h2>
    <input type="text" id="p-name" placeholder="åå‰ã‚’å…¥åŠ›">
    <textarea id="p-ans" placeholder="ç­”ãˆã‚’å…¥åŠ›" oninput="reportTyping(this.value)" style="width:90%; height:100px; font-size:1.8rem; background:#000; color:#fff; border-radius:8px; border:2px solid #333; padding:10px; margin-bottom:15px;"></textarea>
    <button class="btn-success" onclick="sendAns()">å›ç­”ã‚’é€ä¿¡ã™ã‚‹</button>
    <div id="status-msg-player">åå‰ã¨ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
</div>

<script>
    // Firebaseè¨­å®š
    const firebaseConfig = { databaseURL: "https://realtime-database-c0015-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let subWindow = null;

    function initRole(role) {
        document.getElementById('setup-ui').style.display = 'none';
        document.getElementById(role + '-ui').style.display = 'block';
        
        if(role === 'admin') {
            // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ã‚µãƒ–ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã«é€ã‚‹
            db.ref().on('value', snap => {
                const data = snap.val();
                if(subWindow && !subWindow.closed) {
                    subWindow.sync(data);
                }
            });
        }
    }

    // --- å›ç­”è€…ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ---
    function reportTyping(val) {
        const name = document.getElementById('p-name').value.trim();
        if(name) db.ref('typing/' + name).set(val.length > 0);
    }

    function sendAns() {
        const name = document.getElementById('p-name').value.trim();
        const ans = document.getElementById('p-ans').value.trim();
        if(!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if(!ans) return alert("ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        db.ref('answers/' + name).set(ans);
        db.ref('typing/' + name).set(false);
        document.getElementById('status-msg-player').innerText = "é€ä¿¡ã—ã¾ã—ãŸï¼å…¬é–‹ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚";
        document.getElementById('status-msg-player').style.color = "#2ecc71";
    }

    // --- ç®¡ç†è€…ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ---
    function resetBoard() {
        if(confirm("å…¨å“¡ã®å›ç­”ã‚’å‰Šé™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            db.ref().set({ answers: null, typing: null, reveal: false });
            document.getElementById('status-msg').innerText = "ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ";
        }
    }

    // ã‚µãƒ–ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ï¼ˆè¦–è´è€…ç”»é¢ï¼‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function openDisplay() {
        subWindow = window.open("", "QuizDisplay", "width=1200,height=800");
        subWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Quiz Board Display</title>
                <style>
                    body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 20px; text-align: center; overflow-y: auto; }
                    #board-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 30px; }
                    .card { background: #1a1a1a; border: 5px solid #444; border-radius: 20px; min-width: 280px; padding: 25px; transition: 0.3s; }
                    .name { font-size: 1.4rem; color: #4aa3ff; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px; font-weight: bold; }
                    .ans { font-size: 3rem; font-weight: bold; color: #f1c40f; min-height: 1.5em; display: flex; align-items: center; justify-content: center; word-break: break-all; }
                    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
                    .typing { color: #3498db; font-size: 1.2rem; animation: blink 1s infinite; }
                </style>
            </head>
            <body>
                <h1 style="font-size: 2.5rem; margin-bottom: 10px;">LIVE ANSWER BOARD</h1>
                <div id="board-area"></div>
                <script>
                    function sync(data) {
                        const area = document.getElementById('board-area');
                        if(!data) { area.innerHTML = ""; return; }
                        
                        // å›ç­”è€…ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆå›ç­”ãŒã‚ã‚‹äººã€ã¾ãŸã¯å…¥åŠ›ä¸­ã®äººï¼‰
                        const names = Array.from(new Set([
                            ...Object.keys(data.answers || {}), 
                            ...Object.keys(data.typing || {})
                        ]));

                        area.innerHTML = names.map(n => {
                            const ans = data.answers ? data.answers[n] : null;
                            const isTyping = data.typing ? data.typing[n] : false;
                            
                            let content = "";
                            if (data.reveal) {
                                // å…¬é–‹ãƒ¢ãƒ¼ãƒ‰
                                content = ans || "";
                            } else {
                                // éš è”½ãƒ¢ãƒ¼ãƒ‰
                                if (ans) content = "ï¼Ÿï¼Ÿï¼Ÿ";
                                else if (isTyping) content = "<span class='typing'>ğŸ–Š å…¥åŠ›ä¸­...</span>";
                            }

                            if (!content) return ""; // ä½•ã‚‚ãªã‘ã‚Œã°è¡¨ç¤ºã—ãªã„

                            return '<div class="card"><div class="name">' + n + '</div><div class="ans">' + content + '</div></div>';
                        }).join('');
                    }
                    window.sync = sync;
                <\/script>
            </body>
            </html>
        `);
    }
</script>
</body>
</html>
