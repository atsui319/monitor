<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>QuizConsole Pro - Final Fixed</title>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
/* ===== å…ƒCSSå®Œå…¨ä¿æŒ ===== */
:root { --bg:#f0f2f5; --primary:#3498db; --danger:#e74c3c; --success:#2ecc71; --dark:#2c3e50; --test:#6c5ce7; --gold:#f1c40f; }
body{font-family:sans-serif;background:var(--bg);margin:0;padding:10px;height:100vh;overflow:hidden}
.page-section{display:none;height:100%} #role-ui{display:block}
.container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);margin-bottom:15px}
.admin-flex{display:flex;gap:15px;height:calc(100vh - 40px);max-width:1600px;margin:0 auto}
.main-panel{flex:1;overflow-y:auto}
.sidebar{width:380px;display:flex;flex-direction:column;gap:15px}
.sidebar-section{background:#fff;padding:15px;border-radius:12px;border:1px solid #ddd;min-height:0;display:flex;flex-direction:column}
#display{font-size:1.8rem;background:var(--dark);color:#fff;padding:20px;border-radius:8px;display:flex;flex-wrap:wrap;border:4px solid #444}
#display span{border-bottom:2px solid #555;margin-right:2px;min-width:.8em;text-align:center}
#display span.hidden{visibility:hidden}
.btn-genre{padding:6px;font-size:.7rem;cursor:pointer;flex:1;border:1px solid #ccc;background:#fff}
.btn-genre.active{background:var(--primary);color:#fff}
.mgr-item{display:flex;justify-content:space-between;border-bottom:1px solid #eee;font-size:.9rem}
.board-ans-item{padding:8px;border-radius:6px;margin-top:4px;border-left:6px solid #ccc;background:#f8f9fa}
#remote-button{width:180px;height:180px;border-radius:50%;font-size:2rem;font-weight:bold}
#remote-button:not(:disabled){background:var(--danger);color:#fff}
</style>
</head>

<body>

<!-- ================= å½¹å‰²é¸æŠ ================= -->
<div id="role-ui" class="page-section">
  <div class="container" style="max-width:400px;margin:100px auto;text-align:center">
    <h2>QuizConsole Pro</h2>
    <button style="width:100%;padding:20px;margin-bottom:10px" onclick="switchPage('admin')">ğŸ’» ç®¡ç†è€…</button>
    <button style="width:100%;padding:20px;background:var(--test);color:#fff" onclick="switchPage('player')">ğŸ“± å›ç­”è€…</button>
  </div>
</div>

<!-- ================= ç®¡ç†ç”»é¢ ================= -->
<div id="admin-ui" class="page-section">
<div class="admin-flex">

<div class="main-panel">
<div class="container">

<select id="gameMode" onchange="db.ref('mode').set(this.value)">
<option value="push">æ—©æŠ¼ã—</option>
<option value="board">ãƒœãƒ¼ãƒ‰</option>
<option value="all_board">å…¨å“¡ãƒœãƒ¼ãƒ‰</option>
</select>

<button onclick="resetAll()" style="background:var(--danger);color:#fff">å…¨æ¶ˆå»</button>

<div id="activePlayer" style="font-size:2.2rem;color:var(--danger);margin:10px 0">å¾…æ©Ÿä¸­</div>

<div id="display"></div>

<div style="margin-top:10px">
<button onclick="judge(true)">â­•</button>
<button onclick="judge(false)">âŒ</button>
</div>

<div style="margin-top:10px">
<input type="range" id="readSpeed" min="50" max="1000" value="150">
<button onclick="startQuiz()">è‡ªå‹•èª­ä¸Š</button>
</div>

</div>
</div>

<div class="sidebar">
<div class="sidebar-section">
<h3>å•é¡Œæ¤œç´¢</h3>
<input type="text" id="search" placeholder="æ¤œç´¢" oninput="renderList()">
<div id="quiz-list-area"></div>
</div>
</div>

</div>
</div>

<!-- ================= å›ç­”è€… ================= -->
<div id="player-ui" class="page-section">
<div class="container" style="text-align:center">
<div style="font-size:2rem">Score: <span id="p-score">0</span></div>
<input id="p-name" placeholder="åå‰">
<button id="remote-button" onclick="pushBtn()">PUSH</button>
</div>
</div>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  databaseURL:"https://realtime-database-c0015-default-rtdb.firebaseio.com/"
});
const db=firebase.database();

/* ================= çŠ¶æ…‹ ================= */
let masterData={all:[]}, activeGenre='all', usedSet=new Set();
let currentQuiz={q:"",a:""}, revealed=[], timer=null;

/* ================= CSVå®‰å…¨ãƒ‘ãƒ¼ã‚¹ ================= */
function parseCSV(line){
  const m=line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
  return m ? m.map(v=>v.replace(/^"|"$/g,"").trim()) : [];
}

/* ================= URLSï¼ˆå…ƒã‚³ãƒ¼ãƒ‰å®Œå…¨ç¶­æŒï¼‰ ================= */
const URLS={
  ori:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSFuFjp8CnBMqfdRPKbQ_FPC6zWwgdQBVdTDsdWTHbBN92vXADxbVTmHdLm_C3Yn-Eeu5ZWm9WXRb0c/pub?output=csv",
  ent:"https://docs.google.com/spreadsheets/d/e/2PACX-1vRjKfK1zTkytDnO1HiVRHa0N79VJncU_IXC3uv8Q2EBvBIm5mRPw82ie-widupSvvlR1vQdkVeeIIMM/pub?output=csv",
  anime:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQTBRf9k4zS7Ht5s7GKejqT2d-cyWbDHd19DwTPmAzoHe40d9nV1cVu-RH565sIq9GbYmEKkzhpBytp/pub?output=csv",
  social:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTXVYOqHu_0VRIkiVK0RQO-ZWPZ6pHGqIw5VxBWdOlg3-HbP3q26gM0fVxTndREhjqbaxFzcjeuoMcE/pub?output=csv",
  life:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSTr7JL0lBCMLRBFi-CraPlJxzp4xrGD8RSnc8MSuoV3ORISo0iCFWMmI_FCtDlgkxwPqmv_TwAvufn/pub?output=csv",
  sport:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSJYls3O8_98SKNWqx34c0V5HLIaXdxxA8v4E3c1iwrTFZBL1TSxzeem9AbKZKYfMkQEcu7bECcsgVo/pub?output=csv"
};

/* ================= ç®¡ç†åˆæœŸåŒ– ================= */
async function initAdmin(){
  masterData={all:[]};
  for(const [k,url] of Object.entries(URLS)){
    masterData[k]=[];
    const text=await (await fetch(url+"&t="+Date.now())).text();
    text.split("\n").slice(1).forEach(l=>{
      const p=parseCSV(l);
      if(p[0]&&p[1]){
        const item={q:p[0],a:p[1]};
        masterData[k].push(item);
        masterData.all.push(item);
      }
    });
  }
  renderList();
}

/* ================= æ¤œç´¢ä¿®æ­£ ================= */
function renderList(){
  const s=document.getElementById('search').value.toLowerCase();
  let list=masterData.all;
  if(s) list=list.filter(i=>i.q.toLowerCase().includes(s)||i.a.toLowerCase().includes(s));
  document.getElementById('quiz-list-area').innerHTML=
    list.sort(()=>Math.random()-0.5).slice(0,30)
    .map(i=>`<div onclick="applyQuiz('${i.q.replace(/'/g,"\\'")}','${i.a.replace(/'/g,"\\'")}')">
    <b>${i.a}</b><br><small>${i.q}</small></div>`).join('');
}

/* ================= å‡ºé¡Œ ================= */
function applyQuiz(q,a){
  clearInterval(timer);
  currentQuiz={q,a};
  revealed=[];
  db.ref().update({status:"waiting",winner:"",typing:null});
  sync();
}

/* ================= èª­ä¸Šï¼ˆäºŒé‡é˜²æ­¢ï¼‰ ================= */
function startQuiz(){
  clearInterval(timer);
  db.ref('status').set('active');
  const sp=parseInt(document.getElementById('readSpeed').value);
  timer=setInterval(()=>{
    if(revealed.length<currentQuiz.q.length){
      let i=0; while(revealed.includes(i)) i++;
      revealed.push(i); sync();
    }else clearInterval(timer);
  },sp);
}

/* ================= è¡¨ç¤º ================= */
function sync(){
  document.getElementById('display').innerHTML=
    [...currentQuiz.q].map((c,i)=>revealed.includes(i)?`<span>${c}</span>`:`<span class="hidden">${c}</span>`).join('');
}

/* ================= PUSHä¿®æ­£ ================= */
function pushBtn(){
  const n=document.getElementById('p-name').value.trim();
  if(!n) return alert("åå‰ã‚’å…¥åŠ›");
  db.ref('winner').transaction(c=>c||n,(_,ok)=>{if(ok)db.ref('status').set('pushed')});
}

/* ================= æ­£èª¤ ================= */
function judge(ok){
  db.ref().once('value',s=>{
    const d=s.val(), p=d.winner;
    if(!p) return;
    if(ok) db.ref('scores/'+p).transaction(v=>(v||0)+1);
    else db.ref('scores/'+p).transaction(v=>(v||0)-1);
    db.ref().update({winner:"",status:"active"});
  });
}

/* ================= å…¨æ¶ˆå» ================= */
function resetAll(){
  if(!confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) return;
  usedSet.clear();
  db.ref().set({
    status:"idle",
    mode:"push",
    scores:null,
    waits:null,
    winner:"",
    typing:null,
    isGameSet:false
  });
}

/* ================= ç”»é¢åˆ‡æ›¿ ================= */
function switchPage(p){
  document.querySelectorAll('.page-section').forEach(e=>e.style.display='none');
  document.getElementById(p+'-ui').style.display='block';
  if(p==='admin') initAdmin();
}
</script>

</body>
</html>
